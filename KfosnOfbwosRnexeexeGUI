-- Custom Trolling UI - Blocky Windows Style (Green & Purple)
-- Main tab mostly wired up - February 2025 version

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local StarterGui = game:GetService("StarterGui")
local Workspace = game:GetService("Workspace")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")
local mouse = player:GetMouse()
local cam = Workspace.CurrentCamera

-- Prevent duplicate UIs
local existing = playerGui:FindFirstChild("CustomTrollingUI")
if existing then existing:Destroy() end

local screenGui = Instance.new("ScreenGui")
screenGui.Name = "CustomTrollingUI"
screenGui.IgnoreGuiInset = true
screenGui.Parent = playerGui

-- Variables
local detailedPath = false
local shovelFlag = false
local deleteFlag = false
local rainbow = false
local rainbowSky = false
local selectedBlock = false
local currentMaterial = "neon"
local h = 0
local selectedBlockPart = nil           -- renamed for clarity
local waitingForClick = false
local spraypaint = false
local ka = false
local DeleteClickAura = false
local DCAPos = nil
local deleteAuraBox = nil
local showEnlightens = false
local showInvis = false
local mode = "both \240\159\164\157"

local paintTool, paintEvent, shovelEvent, deleteEvent

local rayParams = RaycastParams.new()
rayParams.FilterType = Enum.RaycastFilterType.Exclude
rayParams.FilterDescendantsInstances = {player.Character}

-- ──────────────────────────────────────────────────────────────
--   Core Helper Functions (ported from original)
-- ──────────────────────────────────────────────────────────────

local function normalToFace(n)
    local a = math.abs
    if a(n.X) > a(n.Y) and a(n.X) > a(n.Z) then
        return n.X > 0 and Enum.NormalId.Right or Enum.NormalId.Left
    elseif a(n.Y) > a(n.Z) then
        return n.Y > 0 and Enum.NormalId.Top or Enum.NormalId.Bottom
    else
        return n.Z > 0 and Enum.NormalId.Back or Enum.NormalId.Front
    end
end

local function refreshTools()
    local char = player.Character
    if not char then return end
    local bp = player.Backpack

    local function find(name)
        return char:FindFirstChild(name) or bp:FindFirstChild(name)
    end

    local shovel = find("Shovel")
    shovelEvent = shovel and shovel:FindFirstChild("Script") and shovel.Script:FindFirstChild("Event")

    local del = find("Delete")
    deleteEvent = del and del:FindFirstChild("Script") and del.Script:FindFirstChild("Event")

    local paint = find("Paint")
    paintTool = paint
    local pscr = paint and paint:FindFirstChild("Script")
    paintEvent = pscr and pscr:FindFirstChild("Event")
end

local function getNearestBlock(pos)
    local bricks = Workspace:FindFirstChild("Bricks")
    if not bricks then return nil end
    local myFolder = bricks:FindFirstChild(player.Name)
    if not myFolder then return nil end

    local nearest, minDist
    for _, part in myFolder:GetDescendants() do
        if part:IsA("BasePart") then
            local d = (part.Position - pos).Magnitude
            if not minDist or d < minDist then
                nearest = part
                minDist = d
            end
        end
    end
    return nearest
end

-- ──────────────────────────────────────────────────────────────
--   UI Creation
-- ──────────────────────────────────────────────────────────────

local bubble = Instance.new("TextButton")
bubble.Text = "+"
bubble.Size = UDim2.new(0,70,0,70)
bubble.Position = UDim2.new(1,-90,1,-90)
bubble.BackgroundColor3 = Color3.fromRGB(0,140,0)
bubble.TextColor3 = Color3.fromRGB(255,255,255)
bubble.Font = Enum.Font.GothamBold
bubble.TextSize = 48
bubble.BorderSizePixel = 3
bubble.BorderColor3 = Color3.fromRGB(140,0,140)
bubble.Parent = screenGui

local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0,500,0,380)
mainFrame.Position = UDim2.new(0.5,-250,0.5,-190)
mainFrame.BackgroundColor3 = Color3.fromRGB(192,192,192)
mainFrame.BorderSizePixel = 2
mainFrame.Visible = false
mainFrame.Parent = screenGui

-- Title bar + drag + close (same as before, shortened for brevity)

-- (omitting title bar / drag / close code for space — copy from previous version or keep yours)

-- Tabs and content frame (same structure)

-- Element helpers (addToggle, addButton — same as before)

-- ──────────────────────────────────────────────────────────────
--   Tab Switching + Content
-- ──────────────────────────────────────────────────────────────

local function switchTab(name)
    -- clear content
    for _, c in content:GetChildren() do
        if c:IsA("GuiObject") then c:Destroy() end
    end

    if name == "Main" then
        addToggle(content, "Rainbow Paint", rainbow, function(v) rainbow = v end)
        addToggle(content, "Shovel", shovelFlag, function(v) shovelFlag = v end)
        addToggle(content, "Delete", deleteFlag, function(v) deleteFlag = v end)
        addToggle(content, "Rainbow Sky", rainbowSky, function(v) rainbowSky = v end)
        addToggle(content, "Detailed Path", detailedPath, function(v) detailedPath = v end)
        addToggle(content, "Spray Paint", spraypaint, function(v) spraypaint = v end)
        addToggle(content, "Kill Aura", ka, function(v) ka = v end)
        addToggle(content, "Delete Aura (click)", DeleteClickAura, function(v) DeleteClickAura = v end)

        addButton(content, "Select Block", function()
            waitingForClick = true
            StarterGui:SetCore("SendNotification", {
                Title = "Select Block",
                Text = "Click on any part to select it",
                Duration = 5
            })
        end)

        addButton(content, "Refresh Tools", function()
            refreshTools()
            StarterGui:SetCore("SendNotification", {
                Title = "Tools",
                Text = "Tools refreshed",
                Duration = 3
            })
        end)

    elseif name == "OP" then
        addButton(content, "OP features - coming next", function() end)

    elseif name == "Players" then
        addToggle(content, "Enlightened ESP", showEnlightens, function(v) showEnlightens = v end)
        addToggle(content, "Invisible ESP", showInvis, function(v) showInvis = v end)
    end

    task.delay(0.1, function()
        content.CanvasSize = UDim2.new(0,0,0, list.AbsoluteContentSize.Y + 30)
    end)
end

-- Connect tab buttons (same as before)

switchTab("Main")

-- ──────────────────────────────────────────────────────────────
--   Input handling
-- ──────────────────────────────────────────────────────────────

mouse.Button1Down:Connect(function()
    if waitingForClick then
        if mouse.Target then
            selectedBlockPart = mouse.Target
            StarterGui:SetCore("SendNotification", {
                Title = "Block Selected",
                Text = selectedBlockPart.Name,
                Duration = 4
            })
        end
        waitingForClick = false
        return
    end

    if DeleteClickAura then
        local hit = mouse.Hit.Position
        DCAPos = hit
    end
end)

-- ──────────────────────────────────────────────────────────────
--   Main loop
-- ──────────────────────────────────────────────────────────────

RunService.RenderStepped:Connect(function(dt)
    h = (h + dt * 2) % 1
    local col = Color3.fromHSV(h, 1, 1)

    refreshTools()  -- keep trying to find tools

    if DeleteClickAura and DCAPos and deleteEvent then
        if not deleteAuraBox then
            deleteAuraBox = Instance.new("Part")
            deleteAuraBox.Anchored = true
            deleteAuraBox.CanCollide = false
            deleteAuraBox.Transparency = 0.65
            deleteAuraBox.Color = Color3.new(1,0.3,0.3)
            deleteAuraBox.Material = Enum.Material.Neon
            deleteAuraBox.Size = Vector3.new(20,20,20)
            deleteAuraBox.Parent = Workspace
        end
        deleteAuraBox.Position = DCAPos

        -- You can add actual deletion logic here later
    elseif deleteAuraBox then
        deleteAuraBox:Destroy()
        deleteAuraBox = nil
    end

    -- Rainbow / delete / shovel etc. can be added here when ready
end)

print("Trolling UI loaded - Main tab should be functional")
